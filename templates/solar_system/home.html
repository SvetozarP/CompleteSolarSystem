{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }} - Explore the Solar System in 3D{% endblock %}

{% block body_class %}solar-system-page{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/solar-system.css' %}">
{% endblock %}

{% block content %}
<!-- 3D Canvas Container -->
<div id="canvas-container" class="canvas-container">
    <canvas id="solar-system-canvas" class="solar-system-canvas"></canvas>
    
    <!-- Canvas Overlay Elements -->
    <div class="canvas-overlay">
        <!-- Tooltip for planet hover -->
        <div id="planet-tooltip" class="planet-tooltip hidden">
            <div class="tooltip-content">
                <h4 id="tooltip-title"></h4>
                <p id="tooltip-info"></p>
            </div>
        </div>
        
        <!-- Planet labels -->
        <div id="planet-labels" class="planet-labels">
            <!-- Labels will be dynamically positioned here -->
        </div>
        
        <!-- Distance measurement tool -->
        <div id="measurement-tool" class="measurement-tool hidden">
            <div class="measurement-line"></div>
            <div class="measurement-info">
                <span id="measurement-distance"></span>
            </div>
        </div>
        
        <!-- Mini-map (optional) -->
        <div id="mini-map" class="mini-map hidden">
            <canvas id="mini-map-canvas" width="200" height="200"></canvas>
        </div>
    </div>
    
    <!-- Canvas Controls Overlay -->
    <div class="canvas-controls">
        <!-- Zoom controls -->
        <div class="zoom-controls">
            <button id="zoom-in" class="zoom-btn" title="Zoom In">+</button>
            <button id="zoom-out" class="zoom-btn" title="Zoom Out">‚àí</button>
            <button id="zoom-reset" class="zoom-btn" title="Reset Zoom">‚åÇ</button>
        </div>
        
        <!-- View mode controls -->
        <div class="view-controls">
            <button id="view-top" class="view-btn" title="Top View">‚¨Ü</button>
            <button id="view-side" class="view-btn" title="Side View">‚û°</button>
            <button id="view-angled" class="view-btn active" title="Angled View">‚¨à</button>
        </div>
        
        <!-- Screenshot button -->
        <div class="utility-controls">
            <button id="screenshot-btn" class="utility-btn" title="Take Screenshot">üì∑</button>
            <button id="toggle-labels" class="utility-btn" title="Toggle Labels">üè∑Ô∏è</button>
            <button id="focus-sun" class="utility-btn" title="Focus on Sun">‚òÄÔ∏è</button>
        </div>
    </div>
</div>

<!-- Educational Information Cards -->
<div id="info-cards" class="info-cards hidden">
    <div class="info-card" id="scale-card">
        <h4>üîç Scale Information</h4>
        <p>Sizes and distances are scaled for visualization. Real space is mostly empty!</p>
        <div class="scale-comparison">
            <div class="scale-item">
                <span class="scale-label">Size Scale:</span>
                <span class="scale-value">1:1,000,000</span>
            </div>
            <div class="scale-item">
                <span class="scale-label">Distance Scale:</span>
                <span class="scale-value">1:10</span>
            </div>
        </div>
    </div>
    
    <div class="info-card" id="facts-card">
        <h4>üåü Did You Know?</h4>
        <div id="rotating-facts">
            <p class="fact active">Jupiter has more mass than all other planets combined!</p>
            <p class="fact">A day on Venus is longer than its year!</p>
            <p class="fact">Saturn would float in a giant bathtub!</p>
            <p class="fact">Uranus rotates on its side!</p>
            <p class="fact">Neptune has the strongest winds in the solar system!</p>
        </div>
    </div>
</div>

<!-- Bottom Statistics Bar -->
<div id="stats-bar" class="stats-bar">
    <div class="stats-container">
        <div class="stat-item">
            <span class="stat-label">Total Planets:</span>
            <span class="stat-value" id="total-planets">{{ total_planets }}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Dwarf Planets:</span>
            <span class="stat-value">{% if has_dwarf_planets %}1{% else %}0{% endif %}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Known Moons:</span>
            <span class="stat-value" id="total-moons">-</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">System Age:</span>
            <span class="stat-value">4.6 billion years</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Viewing Mode:</span>
            <span class="stat-value" id="current-view-mode">Interactive 3D</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Core JavaScript files for Stage 2 -->
<script src="{% static 'js/utils/helpers.js' %}"></script>
<script src="{% static 'js/utils/math-utils.js' %}"></script>
<script src="{% static 'js/utils/api-client.js' %}"></script>
<script src="{% static 'js/utils/texture-loader.js' %}"></script>
<script src="{% static 'js/ui/loading-manager.js' %}"></script>
<script src="{% static 'js/ui/notification-system.js' %}"></script>
<script src="{% static 'js/ui/control-panel.js' %}"></script>
<script src="{% static 'js/solar-system/particle-systems.js' %}"></script>
<script src="{% static 'js/solar-system/scene-manager.js' %}"></script>

<!-- Placeholder modules for Stage 3 -->
<script src="{% static 'js/solar-system/planet-factory.js' %}"></script>
<script src="{% static 'js/solar-system/lighting-system.js' %}"></script>
<script src="{% static 'js/solar-system/camera-controls.js' %}"></script>
<script src="{% static 'js/solar-system/interaction-manager.js' %}"></script>
<script src="{% static 'js/solar-system/orbital-mechanics.js' %}"></script>

<!-- Main application -->
<script src="{% static 'js/solar-system/solar-system-app.js' %}"></script>
{% endblock %}

{% block app_init %}
// Initialize the Solar System application
console.log('Starting Solar System App initialization...');

if (window.SolarSystemApp) {
    window.solarSystemApp = new window.SolarSystemApp({
        containerId: 'canvas-container',
        canvasId: 'solar-system-canvas',
        config: window.SolarSystemConfig
    });
    
    window.solarSystemApp.init().then(() => {
        console.log('Solar System application initialized successfully');
        
        // Hide loading screen and show app
        if (window.LoadingManager) {
            window.LoadingManager.complete();
        }
        
        // Show info cards after a delay
        setTimeout(() => {
            const infoCards = document.getElementById('info-cards');
            if (infoCards) {
                infoCards.classList.remove('hidden');
            }
        }, 2000);
        
        // Start rotating facts
        startFactRotation();
        
    }).catch(error => {
        console.error('Failed to initialize Solar System:', error);
        
        if (window.LoadingManager) {
            window.LoadingManager.error('Failed to load 3D environment');
        }
        
        if (window.NotificationSystem) {
            window.NotificationSystem.showError('Failed to initialize 3D environment. Please check your browser compatibility.');
        }
        
        // Force complete loading anyway so user can see the error
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const appContainer = document.getElementById('app-container');
            if (loadingScreen && appContainer) {
                loadingScreen.style.display = 'none';
                appContainer.style.display = 'flex';
            }
        }, 3000);
    });
} else {
    console.error('SolarSystemApp class not found - check if solar-system-app.js loaded correctly');
    
    // Fallback: complete loading anyway
    setTimeout(() => {
        console.log('Fallback: completing loading without 3D scene');
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        if (loadingScreen && appContainer) {
            loadingScreen.style.display = 'none';
            appContainer.style.display = 'flex';
        }
    }, 2000);
}

// Utility functions
function startFactRotation() {
    const facts = document.querySelectorAll('.fact');
    let currentIndex = 0;
    
    setInterval(() => {
        facts[currentIndex].classList.remove('active');
        currentIndex = (currentIndex + 1) % facts.length;
        facts[currentIndex].classList.add('active');
    }, 5000); // Change fact every 5 seconds
}

// Handle window resize
window.addEventListener('resize', () => {
    if (window.solarSystemApp && window.solarSystemApp.handleResize) {
        window.solarSystemApp.handleResize();
    }
});

// Handle visibility change (pause when tab is not visible)
document.addEventListener('visibilitychange', () => {
    if (window.solarSystemApp && window.solarSystemApp.handleVisibilityChange) {
        window.solarSystemApp.handleVisibilityChange(document.hidden);
    }
});

// Keyboard shortcuts
document.addEventListener('keydown', (event) => {
    if (window.solarSystemApp && window.solarSystemApp.handleKeyPress) {
        window.solarSystemApp.handleKeyPress(event);
    }
});
{% endblock %}